{% extends "base.html" %}

{% load static %}


{% block title %}Mapa{% endblock %}

{% block styles %}
  {{ block.super }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
         integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
         crossorigin=""/>

    <style>
        #map { height: 500px; }
    </style>
{% endblock %}

{% block head_scripts %}
     {{ block.super }}
     <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
{% endblock %}

{% block content %}

<section>
    <h1 class="text-3xl font-bold pb-8">Alcadías CDMX</h1>
    <div id="map"></div>
<script>
    const url = '{% static 'mapas/alcaldias.geojson' %}';
    var map = L.map('map').setView([19.4326, -99.1332], 10); // CDMX

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);
        // Cargar el GeoJSON
   fetch(url)
    .then(r => r.json())
    .then(geo => {
      const getColor = v =>
        v > 1000000 ? '#800026' :
        v > 700000  ? '#BD0026' :
        v > 400000  ? '#E31A1C' :
        v > 200000  ? '#FC4E2A' :
        v > 100000  ? '#FD8D3C' : '#FEB24C';

      const style = f => ({
        color: '#1e3a8a',
        weight: 1,
        fillOpacity: 0.4,
        fillColor: f.properties?.poblacion
          ? getColor(f.properties.poblacion)
          : '#60a5fa' // color por defecto si no hay 'poblacion'
      });

      let geojsonLayer; // para resetear estilos en mouseout

      const onEach = (f, layer) => {
        const nombre = f.properties?.nombre || f.properties?.NOMGEO || 'Sin nombre';
        const pobl   = f.properties?.poblacion;

        layer.bindTooltip(nombre, { sticky: true });

        layer.on({
          mouseover: e => {
            e.target.setStyle({ weight: 3, fillOpacity: 0.65 });
            e.target.bringToFront();
          },
          mouseout:  e => geojsonLayer.resetStyle(e.target),
          click:     e => map.fitBounds(e.target.getBounds())
        });

        // Popup opcional
        layer.bindPopup(
          `<strong>${nombre}</strong>` + (pobl ? `<br>Población: ${pobl.toLocaleString()}` : '')
        );
      };

      geojsonLayer = L.geoJSON(geo, { style, onEachFeature: onEach }).addTo(map);
      map.fitBounds(geojsonLayer.getBounds());

      // Regla/escala opcional
      L.control.scale().addTo(map);
    });


    </script>
</section>
{% endblock %}